---
title: "Online Function"
author: "Kyle Pelham"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

```{r, echo= FALSE}
library(tidyverse)
library(here)
library(ggplot2)
library(onlineBcp)
library(changepoint)
library(lubridate)
library(plotly)
```

```{r}
online_constraint_flow <- function(filename, start_date = NULL, end_date = NULL, min_probability = 0.98, cohen_val= 2, min_segment_length = 0.5){
  
  # Reading in and cleaning the data
  engie  <- read_csv(filename, guess_max = 100000)
  
  # Filtering by date range if start_date and end_date are provided
  if (!is.null(start_date) & !is.null(end_date)) {
    engie <- engie %>%
      filter(DateTime >= start_date & DateTime <= end_date)
  }
  
  df <- engie %>%
    filter(
      !(is.na(constraint_flow))
    ) %>%
    mutate(
      binding_hour = factor(case_when(
        is.na(shadow_price) ~ 0,
        TRUE ~ 1
      ))
    )
  
 # Runs onlineBcp function to find changepoints using the min probability parameter.
  ocp <- online_cp(df$constraint_flow, th_cp = min_probability, theta = 0.7, alpha = 1, beta = 1)
  
 # Table generated from onlineBcp package
  table <- as.data.frame(summary(ocp)$result[[2]])
  
 # Calculate months, difference in mean. and Cohen's D for identified change points to help identify possible regime changes in the next step
  table <- table %>%
    mutate(
      Months = (as.numeric(as.duration(df$DateTime[table$end] - df$DateTime[table$begin]) / ddays(1)))/30.44,
      Diff_Mean= mean - lag(mean),
      Mean_ratio = mean/lag(mean),
      CohenD = (abs(lag(mean) - mean)) / sqrt((SD^2 + lag(SD)^2)/2)
    )
  # Filter change points that meet the criteria for a large changes
  regime_table1 <- table %>%
    mutate(
      LargeChange = case_when(
        CohenD >= cohen_val & Months >= min_segment_length & mean != 0 ~ TRUE,
        TRUE ~ FALSE
      ),
      Start_Date = df$DateTime[table$begin],
      End_Date = df$DateTime[table$end]
    ) %>%
    filter(
      LargeChange == TRUE
    ) 
  
   # If no regime change is found at this point
  if(nrow(regime_table1) == 0) {
  
    message = print('No regime change detected based on given parameters')
      
    plot1 <- plot_ly(data = df,x = ~DateTime, y = ~constraint_flow, type = 'scatter', mode = 'lines') %>% 
    layout(title = paste('No Regime Change Detected: ', unique(df$contingency_uid)), plot_bgcolor = "#e5ecf6", xaxis = list(title = 'Date'), 
         yaxis = list(title = 'Constraint Flow'))
    
    return(list(message,plot = plot1))
  }
    
  # Calculate difference in means & Cohens' D for large change points to identify Regime Changes
  table2 <- regime_table1 %>%
    mutate(
      Diff_Mean= mean - lag(mean),
      Mean_Ratio = mean/lag(mean),
      CohenD = (abs(lag(mean) - mean)) / sqrt((SD^2 + lag(SD)^2)/2)
    )
  
  
  # Filter change points that meet the criteria for a Regime changes
  regime_table2 <- table2 %>%
    mutate(
      RegimeChange = case_when(
        CohenD >= cohen_val & Months >= min_segment_length & mean != 0 ~ TRUE,
        nrow(regime_table1) == 1 ~ TRUE,
        TRUE ~ FALSE
      ),
      Start_Date = df$DateTime[table2$begin],
      End_Date = df$DateTime[table2$end]
    ) %>%
    filter(
      RegimeChange == TRUE
    ) 
   # If no regime change is found at this point
   if(nrow(regime_table2) == 0) {
  
    message = print('No regime change detected based on given parameters')
      
    plot1 <- plot_ly(data = df,x = ~DateTime, y = ~constraint_flow, type = 'scatter', mode = 'lines') %>% 
    layout(title = paste('No Regime Change Detected: ', unique(df$contingency_uid)), plot_bgcolor = "#e5ecf6", xaxis = list(title = 'Date'), 
         yaxis = list(title = 'Constraint Flow'))
    
    return(list(message,plot= plot1))
  }
  
  # Assign regime change points
  cpts <- regime_table2$begin
        
  # Create intervals for regimes  using change points
  intervals <- c(0, cpts, Inf)
        
  # Create labels for intervals
   regime_labels <- seq(from = 1, to = (length(intervals)-1), by = 1)
      
      
  # Bin original data based on intervals  
  bins <- cut(x = 1:length(df[['constraint_flow']]), breaks = intervals, 
                labels= regime_labels, 
                include.lowest = TRUE, right = FALSE  )
      
  # Concat bins to original data
  df$Regime <- bins
      
  # Create interactive plot
  plot2 <- plot_ly(data = df,x = ~DateTime, y = ~constraint_flow, type = 'scatter', mode = 'lines', color = ~Regime) %>% 
    layout(title = paste('Regime Change: ', unique(df$contingency_uid)), plot_bgcolor = "#e5ecf6", xaxis = list(title = 'Date'), 
         yaxis = list(title = 'Constraint Flow'), legend = list(title=list(text='<b> Regime </b>')))
  
  # Create Summary table for regimes
  summary_table <- df %>% 
  group_by(Regime) %>%
  summarise("Regime Start" = min(DateTime), "Regime End" = max(DateTime), "Mean Constraint Flow" = mean(constraint_flow), "Standard Deviation" = sd(constraint_flow))
      
  return(list(summary = summary_table, plot = plot2))
      
}
```

### Online Change Point Analysis

Initial data is loaded that runs from January 2021 to January 2022. No regime change detected so far.

```{r, echo=FALSE}
online1a <- online_constraint_flow('Constraint Flow_pano-spp-100001.csv', start_date = '2021-01-01', end_date = '2022-01-01', cohen_val = 2)
```

```{r}
online1a$plot
```

Adding data for month of February. There is an appearance of possible regime change, but is still not detected.

```{r, echo=FALSE}
online1b <- online_constraint_flow('Constraint Flow_pano-spp-100001.csv', start_date = '2021-01-01', end_date = '2022-02-01', cohen_val = 2)
```

```{r}
online1b$plot
```

Adding data for month of March. Regime change has now been detected.

```{r, echo=FALSE}
online1c <- online_constraint_flow('Constraint Flow_pano-spp-100001.csv', start_date = '2021-01-01', end_date = '2022-03-01', cohen_val = 2)
```

```{r}
online1c$plot
online1c$summary
```

Our function can be more or less strict by adjusting the amount of change it is looking for. Here, it is lowered slightly to pick up this change.

```{r}
online3a <- online_constraint_flow('Constraint Flow_pano-spp-100003.csv', start_date = '2017-08-01', end_date = '2018-02-01', cohen_val = 1.3)
```

```{r}
online3a$plot
```

```{r}
online3b <- online_constraint_flow('Constraint Flow_pano-spp-100003.csv', start_date = '2017-08-01', end_date = '2018-03-01', cohen_val = 1.3)
```

```{r}
online3b$plot
```

```{r}
online3c <- online_constraint_flow('Constraint Flow_pano-spp-100003.csv', start_date = '2017-08-01', end_date = '2018-04-01', cohen_val = 1.3)
```

```{r}
online3c$plot
online3c$summary
```
